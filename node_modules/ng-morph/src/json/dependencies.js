"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPackageJsonDependency = exports.removePackageJsonDependency = exports.addPackageJsonDependency = exports.NodeDependencyType = void 0;
const tslib_1 = require("tslib");
const semver = tslib_1.__importStar(require("semver"));
const consts_1 = require("./consts");
const json_file_1 = require("./json-file");
// eslint-disable-next-line no-restricted-syntax
var NodeDependencyType;
(function (NodeDependencyType) {
    NodeDependencyType["Default"] = "dependencies";
    NodeDependencyType["Dev"] = "devDependencies";
    NodeDependencyType["Peer"] = "peerDependencies";
    NodeDependencyType["Optional"] = "optionalDependencies";
})(NodeDependencyType = exports.NodeDependencyType || (exports.NodeDependencyType = {}));
const ALL_DEPENDENCY_TYPE = [
    NodeDependencyType.Default,
    NodeDependencyType.Dev,
    NodeDependencyType.Optional,
    NodeDependencyType.Peer,
];
function versionSanitize(version) {
    return version.replaceAll(/([\^~])/g, '');
}
function addPackageJsonDependency(tree, dependency, pkgJsonPath = consts_1.PACKAGE_PATH) {
    var _a;
    const { version: oldVersion } = (_a = getPackageJsonDependency(tree, dependency.name, pkgJsonPath)) !== null && _a !== void 0 ? _a : { version: '0.0.0' };
    const { overwrite, type = NodeDependencyType.Default, name, version } = dependency;
    if (!overwrite && semver.gt(versionSanitize(oldVersion), versionSanitize(version))) {
        return;
    }
    const json = new json_file_1.JSONFile(tree, pkgJsonPath);
    const path = [type, name];
    json.modify(path, version);
}
exports.addPackageJsonDependency = addPackageJsonDependency;
function removePackageJsonDependency(tree, name, pkgJsonPath = consts_1.PACKAGE_PATH) {
    const json = new json_file_1.JSONFile(tree, pkgJsonPath);
    ALL_DEPENDENCY_TYPE.forEach((depType) => json.remove([depType, name]));
}
exports.removePackageJsonDependency = removePackageJsonDependency;
function getPackageJsonDependency(tree, name, pkgJsonPath = consts_1.PACKAGE_PATH) {
    const json = new json_file_1.JSONFile(tree, pkgJsonPath);
    for (const depType of ALL_DEPENDENCY_TYPE) {
        const version = json.get([depType, name]);
        if (typeof version === 'string') {
            return {
                type: depType,
                name,
                version,
            };
        }
    }
    return null;
}
exports.getPackageJsonDependency = getPackageJsonDependency;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwZW5kZW5jaWVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZy1tb3JwaC9zcmMvanNvbi9kZXBlbmRlbmNpZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQVFBLHVEQUFpQztBQUVqQyxxQ0FBc0M7QUFDdEMsMkNBQXFDO0FBRXJDLGdEQUFnRDtBQUNoRCxJQUFZLGtCQUtYO0FBTEQsV0FBWSxrQkFBa0I7SUFDMUIsOENBQXdCLENBQUE7SUFDeEIsNkNBQXVCLENBQUE7SUFDdkIsK0NBQXlCLENBQUE7SUFDekIsdURBQWlDLENBQUE7QUFDckMsQ0FBQyxFQUxXLGtCQUFrQixHQUFsQiwwQkFBa0IsS0FBbEIsMEJBQWtCLFFBSzdCO0FBU0QsTUFBTSxtQkFBbUIsR0FBRztJQUN4QixrQkFBa0IsQ0FBQyxPQUFPO0lBQzFCLGtCQUFrQixDQUFDLEdBQUc7SUFDdEIsa0JBQWtCLENBQUMsUUFBUTtJQUMzQixrQkFBa0IsQ0FBQyxJQUFJO0NBQzFCLENBQUM7QUFFRixTQUFTLGVBQWUsQ0FBQyxPQUFlO0lBQ3BDLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDOUMsQ0FBQztBQUVELFNBQWdCLHdCQUF3QixDQUNwQyxJQUFVLEVBQ1YsVUFBMEIsRUFDMUIsV0FBVyxHQUFHLHFCQUFZOztJQUUxQixNQUFNLEVBQUMsT0FBTyxFQUFFLFVBQVUsRUFBQyxHQUFHLE1BQUEsd0JBQXdCLENBQ2xELElBQUksRUFDSixVQUFVLENBQUMsSUFBSSxFQUNmLFdBQVcsQ0FDZCxtQ0FBSSxFQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUMsQ0FBQztJQUV4QixNQUFNLEVBQUMsU0FBUyxFQUFFLElBQUksR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBQyxHQUFHLFVBQVUsQ0FBQztJQUVqRixJQUFJLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFO1FBQ2hGLE9BQU87S0FDVjtJQUVELE1BQU0sSUFBSSxHQUFHLElBQUksb0JBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDN0MsTUFBTSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQXJCRCw0REFxQkM7QUFFRCxTQUFnQiwyQkFBMkIsQ0FDdkMsSUFBVSxFQUNWLElBQVksRUFDWixXQUFXLEdBQUcscUJBQVk7SUFFMUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxvQkFBUSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztJQUU3QyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNFLENBQUM7QUFSRCxrRUFRQztBQUVELFNBQWdCLHdCQUF3QixDQUNwQyxJQUFVLEVBQ1YsSUFBWSxFQUNaLFdBQVcsR0FBRyxxQkFBWTtJQUUxQixNQUFNLElBQUksR0FBRyxJQUFJLG9CQUFRLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRTdDLEtBQUssTUFBTSxPQUFPLElBQUksbUJBQW1CLEVBQUU7UUFDdkMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRTFDLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQzdCLE9BQU87Z0JBQ0gsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsSUFBSTtnQkFDSixPQUFPO2FBQ1YsQ0FBQztTQUNMO0tBQ0o7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDO0FBcEJELDREQW9CQyJ9