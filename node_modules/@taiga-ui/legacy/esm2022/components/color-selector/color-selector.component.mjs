import { __decorate } from "tslib";
import { ChangeDetectionStrategy, Component, EventEmitter, inject, Input, Output, } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { tuiGetGradientData, tuiParseColor, tuiParseGradient, } from '@taiga-ui/cdk/utils/color';
import { tuiDefaultSort, tuiPure } from '@taiga-ui/cdk/utils/miscellaneous';
import { TUI_COLOR_SELECTOR_MODE_NAMES, TUI_COLOR_SELECTOR_OPTIONS, TuiColorSelectorMode, } from './color-selector.options';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "@taiga-ui/core/components/button";
import * as i3 from "./color-picker/color-picker.component";
import * as i4 from "./linear-multi-picker/linear-multi-picker.component";
import * as i5 from "./color-edit/color-edit.component";
import * as i6 from "@taiga-ui/core/directives/dropdown";
import * as i7 from "@taiga-ui/core/components/data-list";
import * as i8 from "@taiga-ui/core/directives/group";
import * as i9 from "./palette/palette.component";
import * as i10 from "@taiga-ui/core/directives/hint";
import * as i11 from "@taiga-ui/kit/directives/chevron";
import * as i12 from "@taiga-ui/core/components/icon";
class TuiColorSelectorComponent {
    constructor() {
        this.selectorOptions = inject(TUI_COLOR_SELECTOR_OPTIONS);
        this.stops = new Map(this.selectorOptions.gradient.steps);
        this.currentStop = this.selectorOptions.gradient.stop;
        this.direction = this.selectorOptions.gradient.direction;
        this.sanitizer = inject(DomSanitizer);
        this.open = false;
        this.colors = this.selectorOptions.colors;
        this.colorChange = new EventEmitter();
        this.color = this.selectorOptions.color;
        this.modes = inject(TUI_COLOR_SELECTOR_MODE_NAMES);
        this.currentMode = this.modes[this.selectorOptions.mode];
        this.buttons = this.selectorOptions.gradient.buttons;
    }
    set colorSetter(color) {
        if (color.startsWith('linear-gradient')) {
            this.parseGradient(color);
        }
        else {
            this.parseColor(color);
        }
    }
    get selectorMode() {
        return this.selectorOptions.selectorMode;
    }
    get palette() {
        return this.filterPalette(this.colors, this.isGradient);
    }
    get stopsKeys() {
        return this.getStopsKeys(this.stops);
    }
    get currentColor() {
        return this.isGradient ? this.getStop(this.currentStop) : this.color;
    }
    get gradient() {
        return this.sanitizer.bypassSecurityTrustStyle(this.getGradient('to right'));
    }
    get isGradient() {
        return this.currentMode === this.modes[TuiColorSelectorMode.Gradient];
    }
    getIcon(direction) {
        return this.selectorOptions.gradient.icons[direction];
    }
    isModeActive(mode) {
        return this.currentMode === mode;
    }
    isDirectionActive(direction) {
        return this.direction === direction;
    }
    onPalettePick(color) {
        this.updateColor(color);
    }
    onDirectionChange(direction) {
        this.direction = direction;
        this.updateColor(this.getGradient(direction));
    }
    onModeSelect(mode) {
        this.currentMode = mode;
        this.open = false;
        this.updateColor(mode === this.modes[TuiColorSelectorMode.SolidColor]
            ? `rgba(${this.color.join(', ')})`
            : this.getGradient(this.direction));
    }
    onIndexChange(index) {
        this.currentStop = this.stopsKeys[index] ?? 0;
    }
    onColorChange(color) {
        if (!this.isGradient) {
            this.updateColor(`rgba(${color.join(', ')})`);
            return;
        }
        this.stops.set(this.currentStop, color);
        this.updateColor(this.getGradient(this.direction));
    }
    onStopsChange(stopsKeys) {
        const removed = this.stopsKeys.find((item) => !stopsKeys.includes(item));
        const added = stopsKeys.find((item) => !this.stopsKeys.includes(item));
        if (removed === undefined && added !== undefined) {
            this.addStop(added);
        }
        if (removed !== undefined && added === undefined) {
            this.removeStop(removed);
        }
        if (removed !== undefined && added !== undefined) {
            this.replaceStop(removed, added);
        }
        this.updateColor(this.getGradient(this.direction));
    }
    getStopsKeys(stops) {
        return Array.from(stops.keys());
    }
    filterPalette(colors, isGradient) {
        const map = new Map(colors);
        map.forEach((value, key) => {
            if ((value.startsWith('linear-gradient') && !isGradient) ||
                (!value.startsWith('linear-gradient') && isGradient)) {
                map.delete(key);
            }
        });
        return map;
    }
    updateColor(color) {
        this.colorChange.emit(color);
    }
    getGradient(direction) {
        return `linear-gradient(${direction}, ${[...this.stopsKeys]
            .sort(tuiDefaultSort)
            .map((key) => `rgba(${this.getStop(key).join(', ')}) ${key * 100}%`)
            .join(', ')})`;
    }
    getStop(stop) {
        return this.stops.get(stop) || this.selectorOptions.gradient.emptyStop;
    }
    addStop(stop) {
        const closest = this.stopsKeys.reduce((prev, curr) => (Math.abs(curr - stop) < Math.abs(prev - stop) ? curr : prev), this.stopsKeys[0] ?? 0);
        this.stops.set(stop, this.getStop(closest));
        this.stops = new Map(this.stops);
        this.currentStop = stop;
    }
    removeStop(stop) {
        this.stops.delete(stop);
        this.stops = new Map(this.stops);
        this.currentStop = this.stopsKeys[0] ?? 0;
    }
    replaceStop(removed, added) {
        const value = this.getStop(removed);
        this.currentStop = added;
        this.stops = new Map(this.stopsKeys.map((key) => key === removed ? [added, value] : [key, this.getStop(key)]));
    }
    parseGradient(color) {
        if (color === this.getGradient(this.direction)) {
            return;
        }
        const gradient = tuiParseGradient(tuiGetGradientData(color));
        this.direction = gradient.side;
        this.currentStop = this.selectorOptions.gradient.stop;
        this.stops = new Map(gradient.stops.length
            ? gradient.stops.map(({ color, position }) => [
                parseFloat(position) / 100,
                tuiParseColor(color),
            ])
            : this.selectorOptions.gradient.steps);
    }
    parseColor(color) {
        this.currentStop = this.selectorOptions.gradient.stop;
        this.color = tuiParseColor(color);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiColorSelectorComponent, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TuiColorSelectorComponent, selector: "tui-color-selector", inputs: { colors: "colors", colorSetter: ["color", "colorSetter"] }, outputs: { colorChange: "colorChange" }, ngImport: i0, template: "<ng-container *ngIf=\"selectorMode\">\n    <div\n        class=\"t-select\"\n        [tuiDropdown]=\"menu\"\n        [(tuiDropdownOpen)]=\"open\"\n    >\n        <button\n            appearance=\"\"\n            size=\"s\"\n            tuiButton\n            tuiChevron\n            type=\"button\"\n        >\n            {{ currentMode }}\n        </button>\n\n        <ng-template #menu>\n            <tui-data-list\n                role=\"menu\"\n                size=\"s\"\n                class=\"t-menu\"\n            >\n                <button\n                    *ngFor=\"let mode of modes\"\n                    role=\"menuitemradio\"\n                    tuiOption\n                    type=\"button\"\n                    [attr.aria-checked]=\"isModeActive(mode)\"\n                    (click)=\"onModeSelect(mode)\"\n                    (keydown.enter.prevent)=\"onModeSelect(mode)\"\n                    (keydown.space.prevent)=\"onModeSelect(mode)\"\n                >\n                    {{ mode }}\n                    <tui-icon\n                        *ngIf=\"isModeActive(mode)\"\n                        icon=\"@tui.check\"\n                        class=\"t-checkmark\"\n                    />\n                </button>\n            </tui-data-list>\n        </ng-template>\n    </div>\n    <hr class=\"t-hr\" />\n</ng-container>\n\n<ng-container *ngIf=\"isGradient\">\n    <div\n        class=\"t-wrapper\"\n        [style.background]=\"gradient\"\n    >\n        <tui-linear-multi-picker\n            class=\"t-gradient\"\n            [value]=\"stopsKeys\"\n            (indexChange)=\"onIndexChange($event)\"\n            (valueChange)=\"onStopsChange($event)\"\n        />\n    </div>\n    <div class=\"t-buttons\">\n        <!-- TODO: Change to `tuiHintDescribe` when figure tuiDriver order issue -->\n        <button\n            *ngFor=\"let button of buttons\"\n            appearance=\"\"\n            size=\"xs\"\n            tuiHintDescribe\n            tuiIconButton\n            type=\"button\"\n            class=\"t-direction\"\n            [class.t-direction_active]=\"isDirectionActive(button)\"\n            [iconStart]=\"getIcon(button)\"\n            [tuiHint]=\"button\"\n            (click)=\"onDirectionChange(button)\"\n        ></button>\n    </div>\n</ng-container>\n<tui-color-picker\n    [color]=\"currentColor\"\n    (colorChange)=\"onColorChange($event)\"\n/>\n<tui-color-edit\n    *ngIf=\"!isGradient\"\n    tuiGroup\n    class=\"t-edit\"\n    [color]=\"color\"\n    (colorChange)=\"onColorChange($event)\"\n/>\n<tui-palette\n    *ngIf=\"palette.size\"\n    class=\"t-palette\"\n    [colors]=\"palette\"\n    (selectedColor)=\"onPalettePick($event)\"\n/>\n", styles: [":host{position:relative;display:block;isolation:isolate;inline-size:22.6rem}.t-wrapper{position:relative;margin:1.25rem;border-radius:.5rem}.t-wrapper:after{position:absolute;top:0;left:0;inline-size:100%;block-size:100%;content:\"\";box-shadow:inset 0 0 0 1px #00000014;pointer-events:none;border-radius:inherit}.t-wrapper:before{position:absolute;top:0;left:0;inline-size:100%;block-size:100%;content:\"\";z-index:-1;background-image:linear-gradient(45deg,var(--tui-base-03) 25%,transparent 25%,transparent 75%,var(--tui-base-03) 75%,var(--tui-base-03)),linear-gradient(45deg,var(--tui-base-03) 25%,transparent 25%,transparent 75%,var(--tui-base-03) 75%,var(--tui-base-03));background-size:.375rem .375rem;background-position:0 0,.1875rem .1875rem;border-radius:inherit}.t-hr{block-size:1px;margin:0 0 0 -1px;border:none;background:var(--tui-base-03)}.t-gradient{margin:0 .5rem;border-radius:inherit}.t-select{margin:.75rem .5rem 0}.t-arrow{transition-property:transform;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out}.t-arrow_rotated{transform:rotate(180deg)}.t-menu{inline-size:11.25rem}.t-checkmark{margin-left:auto;inline-size:1rem;block-size:1rem}.t-buttons{display:flex;padding:0 .75rem 1.25rem;justify-content:space-between}.t-direction{color:var(--tui-text-02);margin:0 .375rem}.t-direction:hover,.t-direction_active{color:var(--tui-text-01);background:var(--tui-secondary-hover)}.t-edit{margin:1.25rem}.t-palette{box-sizing:border-box;box-shadow:inset 0 1px var(--tui-base-03)}\n"], dependencies: [{ kind: "directive", type: i1.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i2.TuiButton, selector: "a[tuiButton],button[tuiButton],a[tuiIconButton],button[tuiIconButton]", inputs: ["size"] }, { kind: "component", type: i3.TuiColorPickerComponent, selector: "tui-color-picker", inputs: ["color"], outputs: ["colorChange"] }, { kind: "component", type: i4.TuiLinearMultiPickerComponent, selector: "tui-linear-multi-picker", inputs: ["value"], outputs: ["valueChange", "indexChange"] }, { kind: "component", type: i5.TuiColorEditComponent, selector: "tui-color-edit", inputs: ["color"], outputs: ["colorChange"] }, { kind: "directive", type: i6.TuiDropdownDirective, selector: "[tuiDropdown]:not(ng-container):not(ng-template)", inputs: ["tuiDropdown"], exportAs: ["tuiDropdown"] }, { kind: "directive", type: i6.TuiDropdownOpen, selector: "[tuiDropdown][tuiDropdownOpen],[tuiDropdown][tuiDropdownOpenChange]", inputs: ["tuiDropdownEnabled", "tuiDropdownOpen"], outputs: ["tuiDropdownOpenChange"] }, { kind: "component", type: i7.TuiDataListComponent, selector: "tui-data-list", inputs: ["emptyContent", "size"] }, { kind: "component", type: i7.TuiOption, selector: "button[tuiOption], a[tuiOption], label[tuiOption]", inputs: ["disabled", "value"] }, { kind: "directive", type: i8.TuiGroup, selector: "[tuiGroup]:not(ng-container)", inputs: ["orientation", "collapsed", "rounded", "size"] }, { kind: "component", type: i9.TuiPaletteComponent, selector: "tui-palette", inputs: ["colors"], outputs: ["selectedColor"] }, { kind: "directive", type: i10.TuiHintDirective, selector: "[tuiHint]:not(ng-container):not(ng-template)", inputs: ["tuiHintContext", "tuiHintAppearance", "tuiHint"] }, { kind: "directive", type: i10.TuiHintDescribe, selector: "[tuiHintDescribe]", inputs: ["tuiHintDescribe"] }, { kind: "directive", type: i11.TuiChevron, selector: "[tuiChevron]", inputs: ["tuiChevron"] }, { kind: "component", type: i12.TuiIcon, selector: "tui-icon", inputs: ["icon", "background"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
__decorate([
    tuiPure
], TuiColorSelectorComponent.prototype, "getStopsKeys", null);
__decorate([
    tuiPure
], TuiColorSelectorComponent.prototype, "filterPalette", null);
export { TuiColorSelectorComponent };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiColorSelectorComponent, decorators: [{
            type: Component,
            args: [{ standalone: false, selector: 'tui-color-selector', changeDetection: ChangeDetectionStrategy.OnPush, template: "<ng-container *ngIf=\"selectorMode\">\n    <div\n        class=\"t-select\"\n        [tuiDropdown]=\"menu\"\n        [(tuiDropdownOpen)]=\"open\"\n    >\n        <button\n            appearance=\"\"\n            size=\"s\"\n            tuiButton\n            tuiChevron\n            type=\"button\"\n        >\n            {{ currentMode }}\n        </button>\n\n        <ng-template #menu>\n            <tui-data-list\n                role=\"menu\"\n                size=\"s\"\n                class=\"t-menu\"\n            >\n                <button\n                    *ngFor=\"let mode of modes\"\n                    role=\"menuitemradio\"\n                    tuiOption\n                    type=\"button\"\n                    [attr.aria-checked]=\"isModeActive(mode)\"\n                    (click)=\"onModeSelect(mode)\"\n                    (keydown.enter.prevent)=\"onModeSelect(mode)\"\n                    (keydown.space.prevent)=\"onModeSelect(mode)\"\n                >\n                    {{ mode }}\n                    <tui-icon\n                        *ngIf=\"isModeActive(mode)\"\n                        icon=\"@tui.check\"\n                        class=\"t-checkmark\"\n                    />\n                </button>\n            </tui-data-list>\n        </ng-template>\n    </div>\n    <hr class=\"t-hr\" />\n</ng-container>\n\n<ng-container *ngIf=\"isGradient\">\n    <div\n        class=\"t-wrapper\"\n        [style.background]=\"gradient\"\n    >\n        <tui-linear-multi-picker\n            class=\"t-gradient\"\n            [value]=\"stopsKeys\"\n            (indexChange)=\"onIndexChange($event)\"\n            (valueChange)=\"onStopsChange($event)\"\n        />\n    </div>\n    <div class=\"t-buttons\">\n        <!-- TODO: Change to `tuiHintDescribe` when figure tuiDriver order issue -->\n        <button\n            *ngFor=\"let button of buttons\"\n            appearance=\"\"\n            size=\"xs\"\n            tuiHintDescribe\n            tuiIconButton\n            type=\"button\"\n            class=\"t-direction\"\n            [class.t-direction_active]=\"isDirectionActive(button)\"\n            [iconStart]=\"getIcon(button)\"\n            [tuiHint]=\"button\"\n            (click)=\"onDirectionChange(button)\"\n        ></button>\n    </div>\n</ng-container>\n<tui-color-picker\n    [color]=\"currentColor\"\n    (colorChange)=\"onColorChange($event)\"\n/>\n<tui-color-edit\n    *ngIf=\"!isGradient\"\n    tuiGroup\n    class=\"t-edit\"\n    [color]=\"color\"\n    (colorChange)=\"onColorChange($event)\"\n/>\n<tui-palette\n    *ngIf=\"palette.size\"\n    class=\"t-palette\"\n    [colors]=\"palette\"\n    (selectedColor)=\"onPalettePick($event)\"\n/>\n", styles: [":host{position:relative;display:block;isolation:isolate;inline-size:22.6rem}.t-wrapper{position:relative;margin:1.25rem;border-radius:.5rem}.t-wrapper:after{position:absolute;top:0;left:0;inline-size:100%;block-size:100%;content:\"\";box-shadow:inset 0 0 0 1px #00000014;pointer-events:none;border-radius:inherit}.t-wrapper:before{position:absolute;top:0;left:0;inline-size:100%;block-size:100%;content:\"\";z-index:-1;background-image:linear-gradient(45deg,var(--tui-base-03) 25%,transparent 25%,transparent 75%,var(--tui-base-03) 75%,var(--tui-base-03)),linear-gradient(45deg,var(--tui-base-03) 25%,transparent 25%,transparent 75%,var(--tui-base-03) 75%,var(--tui-base-03));background-size:.375rem .375rem;background-position:0 0,.1875rem .1875rem;border-radius:inherit}.t-hr{block-size:1px;margin:0 0 0 -1px;border:none;background:var(--tui-base-03)}.t-gradient{margin:0 .5rem;border-radius:inherit}.t-select{margin:.75rem .5rem 0}.t-arrow{transition-property:transform;transition-duration:var(--tui-duration, .3s);transition-timing-function:ease-in-out}.t-arrow_rotated{transform:rotate(180deg)}.t-menu{inline-size:11.25rem}.t-checkmark{margin-left:auto;inline-size:1rem;block-size:1rem}.t-buttons{display:flex;padding:0 .75rem 1.25rem;justify-content:space-between}.t-direction{color:var(--tui-text-02);margin:0 .375rem}.t-direction:hover,.t-direction_active{color:var(--tui-text-01);background:var(--tui-secondary-hover)}.t-edit{margin:1.25rem}.t-palette{box-sizing:border-box;box-shadow:inset 0 1px var(--tui-base-03)}\n"] }]
        }], propDecorators: { colors: [{
                type: Input
            }], colorChange: [{
                type: Output
            }], colorSetter: [{
                type: Input,
                args: ['color']
            }], getStopsKeys: [], filterPalette: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3Itc2VsZWN0b3IuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGVnYWN5L2NvbXBvbmVudHMvY29sb3Itc2VsZWN0b3IvY29sb3Itc2VsZWN0b3IuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGVnYWN5L2NvbXBvbmVudHMvY29sb3Itc2VsZWN0b3IvY29sb3Itc2VsZWN0b3IudGVtcGxhdGUuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNILHVCQUF1QixFQUN2QixTQUFTLEVBQ1QsWUFBWSxFQUNaLE1BQU0sRUFDTixLQUFLLEVBQ0wsTUFBTSxHQUNULE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUV2RCxPQUFPLEVBQ0gsa0JBQWtCLEVBQ2xCLGFBQWEsRUFDYixnQkFBZ0IsR0FDbkIsTUFBTSwyQkFBMkIsQ0FBQztBQUNuQyxPQUFPLEVBQUMsY0FBYyxFQUFFLE9BQU8sRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBRTFFLE9BQU8sRUFDSCw2QkFBNkIsRUFDN0IsMEJBQTBCLEVBQzFCLG9CQUFvQixHQUN2QixNQUFNLDBCQUEwQixDQUFDOzs7Ozs7Ozs7Ozs7OztBQUVsQyxNQU9hLHlCQUF5QjtJQVB0QztRQVFxQixvQkFBZSxHQUFHLE1BQU0sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQzlELFVBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNyRCxnQkFBVyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNqRCxjQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDO1FBRTNDLGNBQVMsR0FBRyxNQUFNLENB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QyxFQUFDLEtBQUssRUFBRSxRQUFRLEVBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ25CLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRyxHQUFHO2dCQUMxQixhQUFhLENBQUMsS0FBSyxDQUFDO2FBQ3ZCLENBQ0o7WUFDSCxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUM1QyxDQUFDO0lBQ04sQ0FBQztJQUVPLFVBQVUsQ0FBQyxLQUFhO1FBQzVCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3RELElBQUksQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3RDLENBQUM7K0dBck5RLHlCQUF5QjttR0FBekIseUJBQXlCLHdLQy9CdEMsMHBGQTJGQTs7QUQrRFk7SUFEUCxPQUFPOzZEQUdQO0FBR087SUFEUCxPQUFPOzhEQWlCUDtTQWhKUSx5QkFBeUI7NEZBQXpCLHlCQUF5QjtrQkFQckMsU0FBUztpQ0FDTSxLQUFLLFlBQ1Asb0JBQW9CLG1CQUdiLHVCQUF1QixDQUFDLE1BQU07OEJBWXhDLE1BQU07c0JBRFosS0FBSztnQkFJVSxXQUFXO3NCQUQxQixNQUFNO2dCQVlJLFdBQVc7c0JBRHJCLEtBQUs7dUJBQUMsT0FBTztnQkFvR04sWUFBWSxNQUtaLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICAgIENvbXBvbmVudCxcbiAgICBFdmVudEVtaXR0ZXIsXG4gICAgaW5qZWN0LFxuICAgIElucHV0LFxuICAgIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgdHlwZSB7U2FmZVN0eWxlfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7RG9tU2FuaXRpemVyfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB0eXBlIHtUdWlHcmFkaWVudERpcmVjdGlvbn0gZnJvbSAnQHRhaWdhLXVpL2Nkay91dGlscy9jb2xvcic7XG5pbXBvcnQge1xuICAgIHR1aUdldEdyYWRpZW50RGF0YSxcbiAgICB0dWlQYXJzZUNvbG9yLFxuICAgIHR1aVBhcnNlR3JhZGllbnQsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsvdXRpbHMvY29sb3InO1xuaW1wb3J0IHt0dWlEZWZhdWx0U29ydCwgdHVpUHVyZX0gZnJvbSAnQHRhaWdhLXVpL2Nkay91dGlscy9taXNjZWxsYW5lb3VzJztcblxuaW1wb3J0IHtcbiAgICBUVUlfQ09MT1JfU0VMRUNUT1JfTU9ERV9OQU1FUyxcbiAgICBUVUlfQ09MT1JfU0VMRUNUT1JfT1BUSU9OUyxcbiAgICBUdWlDb2xvclNlbGVjdG9yTW9kZSxcbn0gZnJvbSAnLi9jb2xvci1zZWxlY3Rvci5vcHRpb25zJztcblxuQENvbXBvbmVudCh7XG4gICAgc3RhbmRhbG9uZTogZmFsc2UsXG4gICAgc2VsZWN0b3I6ICd0dWktY29sb3Itc2VsZWN0b3InLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9jb2xvci1zZWxlY3Rvci50ZW1wbGF0ZS5odG1sJyxcbiAgICBzdHlsZVVybHM6IFsnLi9jb2xvci1zZWxlY3Rvci5zdHlsZS5sZXNzJ10sXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIFR1aUNvbG9yU2VsZWN0b3JDb21wb25lbnQge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc2VsZWN0b3JPcHRpb25zID0gaW5qZWN0KFRVSV9DT0xPUl9TRUxFQ1RPUl9PUFRJT05TKTtcbiAgICBwcml2YXRlIHN0b3BzID0gbmV3IE1hcCh0aGlzLnNlbGVjdG9yT3B0aW9ucy5ncmFkaWVudC5zdGVwcyk7XG4gICAgcHJpdmF0ZSBjdXJyZW50U3RvcCA9IHRoaXMuc2VsZWN0b3JPcHRpb25zLmdyYWRpZW50LnN0b3A7XG4gICAgcHJpdmF0ZSBkaXJlY3Rpb24gPSB0aGlzLnNlbGVjdG9yT3B0aW9ucy5ncmFkaWVudC5kaXJlY3Rpb247XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbml0aXplciA9IGluamVjdChEb21TYW5pdGl6ZXIpO1xuICAgIHByb3RlY3RlZCBvcGVuID0gZmFsc2U7XG5cbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBjb2xvcnMgPSB0aGlzLnNlbGVjdG9yT3B0aW9ucy5jb2xvcnM7XG5cbiAgICBAT3V0cHV0KClcbiAgICBwdWJsaWMgcmVhZG9ubHkgY29sb3JDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICAgIHB1YmxpYyBjb2xvciA9IHRoaXMuc2VsZWN0b3JPcHRpb25zLmNvbG9yO1xuXG4gICAgcHVibGljIHJlYWRvbmx5IG1vZGVzID0gaW5qZWN0KFRVSV9DT0xPUl9TRUxFQ1RPUl9NT0RFX05BTUVTKTtcblxuICAgIHB1YmxpYyBjdXJyZW50TW9kZSA9IHRoaXMubW9kZXNbdGhpcy5zZWxlY3Rvck9wdGlvbnMubW9kZV07XG5cbiAgICBwdWJsaWMgcmVhZG9ubHkgYnV0dG9ucyA9IHRoaXMuc2VsZWN0b3JPcHRpb25zLmdyYWRpZW50LmJ1dHRvbnM7XG5cbiAgICBASW5wdXQoJ2NvbG9yJylcbiAgICBwdWJsaWMgc2V0IGNvbG9yU2V0dGVyKGNvbG9yOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGNvbG9yLnN0YXJ0c1dpdGgoJ2xpbmVhci1ncmFkaWVudCcpKSB7XG4gICAgICAgICAgICB0aGlzLnBhcnNlR3JhZGllbnQoY29sb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wYXJzZUNvbG9yKGNvbG9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc2VsZWN0b3JNb2RlKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rvck9wdGlvbnMuc2VsZWN0b3JNb2RlO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcGFsZXR0ZSgpOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyUGFsZXR0ZSh0aGlzLmNvbG9ycywgdGhpcy5pc0dyYWRpZW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IHN0b3BzS2V5cygpOiBudW1iZXJbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFN0b3BzS2V5cyh0aGlzLnN0b3BzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGN1cnJlbnRDb2xvcigpOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlciwgbnVtYmVyXSB7XG4gICAgICAgIHJldHVybiB0aGlzLmlzR3JhZGllbnQgPyB0aGlzLmdldFN0b3AodGhpcy5jdXJyZW50U3RvcCkgOiB0aGlzLmNvbG9yO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgZ3JhZGllbnQoKTogU2FmZVN0eWxlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2FuaXRpemVyLmJ5cGFzc1NlY3VyaXR5VHJ1c3RTdHlsZSh0aGlzLmdldEdyYWRpZW50KCd0byByaWdodCcpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGlzR3JhZGllbnQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRNb2RlID09PSB0aGlzLm1vZGVzW1R1aUNvbG9yU2VsZWN0b3JNb2RlLkdyYWRpZW50XTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0SWNvbihkaXJlY3Rpb246IFR1aUdyYWRpZW50RGlyZWN0aW9uKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0b3JPcHRpb25zLmdyYWRpZW50Lmljb25zW2RpcmVjdGlvbl07XG4gICAgfVxuXG4gICAgcHVibGljIGlzTW9kZUFjdGl2ZShtb2RlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudE1vZGUgPT09IG1vZGU7XG4gICAgfVxuXG4gICAgcHVibGljIGlzRGlyZWN0aW9uQWN0aXZlKGRpcmVjdGlvbjogVHVpR3JhZGllbnREaXJlY3Rpb24pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlyZWN0aW9uID09PSBkaXJlY3Rpb247XG4gICAgfVxuXG4gICAgcHVibGljIG9uUGFsZXR0ZVBpY2soY29sb3I6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLnVwZGF0ZUNvbG9yKGNvbG9yKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25EaXJlY3Rpb25DaGFuZ2UoZGlyZWN0aW9uOiBUdWlHcmFkaWVudERpcmVjdGlvbik6IHZvaWQge1xuICAgICAgICB0aGlzLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjtcbiAgICAgICAgdGhpcy51cGRhdGVDb2xvcih0aGlzLmdldEdyYWRpZW50KGRpcmVjdGlvbikpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbk1vZGVTZWxlY3QobW9kZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY3VycmVudE1vZGUgPSBtb2RlO1xuICAgICAgICB0aGlzLm9wZW4gPSBmYWxzZTtcblxuICAgICAgICB0aGlzLnVwZGF0ZUNvbG9yKFxuICAgICAgICAgICAgbW9kZSA9PT0gdGhpcy5tb2Rlc1tUdWlDb2xvclNlbGVjdG9yTW9kZS5Tb2xpZENvbG9yXVxuICAgICAgICAgICAgICAgID8gYHJnYmEoJHt0aGlzLmNvbG9yLmpvaW4oJywgJyl9KWBcbiAgICAgICAgICAgICAgICA6IHRoaXMuZ2V0R3JhZGllbnQodGhpcy5kaXJlY3Rpb24pLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbkluZGV4Q2hhbmdlKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jdXJyZW50U3RvcCA9IHRoaXMuc3RvcHNLZXlzW2luZGV4XSA/PyAwO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbkNvbG9yQ2hhbmdlKGNvbG9yOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlciwgbnVtYmVyXSk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuaXNHcmFkaWVudCkge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVDb2xvcihgcmdiYSgke2NvbG9yLmpvaW4oJywgJyl9KWApO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnN0b3BzLnNldCh0aGlzLmN1cnJlbnRTdG9wLCBjb2xvcik7XG4gICAgICAgIHRoaXMudXBkYXRlQ29sb3IodGhpcy5nZXRHcmFkaWVudCh0aGlzLmRpcmVjdGlvbikpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblN0b3BzQ2hhbmdlKHN0b3BzS2V5czogcmVhZG9ubHkgbnVtYmVyW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcmVtb3ZlZCA9IHRoaXMuc3RvcHNLZXlzLmZpbmQoKGl0ZW0pID0+ICFzdG9wc0tleXMuaW5jbHVkZXMoaXRlbSkpO1xuICAgICAgICBjb25zdCBhZGRlZCA9IHN0b3BzS2V5cy5maW5kKChpdGVtKSA9PiAhdGhpcy5zdG9wc0tleXMuaW5jbHVkZXMoaXRlbSkpO1xuXG4gICAgICAgIGlmIChyZW1vdmVkID09PSB1bmRlZmluZWQgJiYgYWRkZWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5hZGRTdG9wKGFkZGVkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZW1vdmVkICE9PSB1bmRlZmluZWQgJiYgYWRkZWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVTdG9wKHJlbW92ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJlbW92ZWQgIT09IHVuZGVmaW5lZCAmJiBhZGRlZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnJlcGxhY2VTdG9wKHJlbW92ZWQsIGFkZGVkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudXBkYXRlQ29sb3IodGhpcy5nZXRHcmFkaWVudCh0aGlzLmRpcmVjdGlvbikpO1xuICAgIH1cblxuICAgIEB0dWlQdXJlXG4gICAgcHJpdmF0ZSBnZXRTdG9wc0tleXMoc3RvcHM6IE1hcDxudW1iZXIsIHVua25vd24+KTogbnVtYmVyW10ge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShzdG9wcy5rZXlzKCkpO1xuICAgIH1cblxuICAgIEB0dWlQdXJlXG4gICAgcHJpdmF0ZSBmaWx0ZXJQYWxldHRlKFxuICAgICAgICBjb2xvcnM6IFJlYWRvbmx5TWFwPHN0cmluZywgc3RyaW5nPixcbiAgICAgICAgaXNHcmFkaWVudDogYm9vbGVhbixcbiAgICApOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICAgICAgY29uc3QgbWFwID0gbmV3IE1hcChjb2xvcnMpO1xuXG4gICAgICAgIG1hcC5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgKHZhbHVlLnN0YXJ0c1dpdGgoJ2xpbmVhci1ncmFkaWVudCcpICYmICFpc0dyYWRpZW50KSB8fFxuICAgICAgICAgICAgICAgICghdmFsdWUuc3RhcnRzV2l0aCgnbGluZWFyLWdyYWRpZW50JykgJiYgaXNHcmFkaWVudClcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIG1hcC5kZWxldGUoa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG1hcDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUNvbG9yKGNvbG9yOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jb2xvckNoYW5nZS5lbWl0KGNvbG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEdyYWRpZW50KGRpcmVjdGlvbjogVHVpR3JhZGllbnREaXJlY3Rpb24pOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gYGxpbmVhci1ncmFkaWVudCgke2RpcmVjdGlvbn0sICR7Wy4uLnRoaXMuc3RvcHNLZXlzXVxuICAgICAgICAgICAgLnNvcnQodHVpRGVmYXVsdFNvcnQpXG4gICAgICAgICAgICAubWFwKChrZXkpID0+IGByZ2JhKCR7dGhpcy5nZXRTdG9wKGtleSkuam9pbignLCAnKX0pICR7a2V5ICogMTAwfSVgKVxuICAgICAgICAgICAgLmpvaW4oJywgJyl9KWA7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTdG9wKHN0b3A6IG51bWJlcik6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcHMuZ2V0KHN0b3ApIHx8IHRoaXMuc2VsZWN0b3JPcHRpb25zLmdyYWRpZW50LmVtcHR5U3RvcDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZFN0b3Aoc3RvcDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGNsb3Nlc3QgPSB0aGlzLnN0b3BzS2V5cy5yZWR1Y2UoXG4gICAgICAgICAgICAocHJldiwgY3VycikgPT4gKE1hdGguYWJzKGN1cnIgLSBzdG9wKSA8IE1hdGguYWJzKHByZXYgLSBzdG9wKSA/IGN1cnIgOiBwcmV2KSxcbiAgICAgICAgICAgIHRoaXMuc3RvcHNLZXlzWzBdID8/IDAsXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5zdG9wcy5zZXQoc3RvcCwgdGhpcy5nZXRTdG9wKGNsb3Nlc3QpKTtcbiAgICAgICAgdGhpcy5zdG9wcyA9IG5ldyBNYXAodGhpcy5zdG9wcyk7XG4gICAgICAgIHRoaXMuY3VycmVudFN0b3AgPSBzdG9wO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlU3RvcChzdG9wOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdG9wcy5kZWxldGUoc3RvcCk7XG4gICAgICAgIHRoaXMuc3RvcHMgPSBuZXcgTWFwKHRoaXMuc3RvcHMpO1xuICAgICAgICB0aGlzLmN1cnJlbnRTdG9wID0gdGhpcy5zdG9wc0tleXNbMF0gPz8gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlcGxhY2VTdG9wKHJlbW92ZWQ6IG51bWJlciwgYWRkZWQ6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0U3RvcChyZW1vdmVkKTtcblxuICAgICAgICB0aGlzLmN1cnJlbnRTdG9wID0gYWRkZWQ7XG4gICAgICAgIHRoaXMuc3RvcHMgPSBuZXcgTWFwKFxuICAgICAgICAgICAgdGhpcy5zdG9wc0tleXMubWFwPFtudW1iZXIsIFtudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJdXT4oKGtleSkgPT5cbiAgICAgICAgICAgICAgICBrZXkgPT09IHJlbW92ZWQgPyBbYWRkZWQsIHZhbHVlXSA6IFtrZXksIHRoaXMuZ2V0U3RvcChrZXkpXSxcbiAgICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUdyYWRpZW50KGNvbG9yOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgaWYgKGNvbG9yID09PSB0aGlzLmdldEdyYWRpZW50KHRoaXMuZGlyZWN0aW9uKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZ3JhZGllbnQgPSB0dWlQYXJzZUdyYWRpZW50KHR1aUdldEdyYWRpZW50RGF0YShjb2xvcikpO1xuXG4gICAgICAgIHRoaXMuZGlyZWN0aW9uID0gZ3JhZGllbnQuc2lkZTtcbiAgICAgICAgdGhpcy5jdXJyZW50U3RvcCA9IHRoaXMuc2VsZWN0b3JPcHRpb25zLmdyYWRpZW50LnN0b3A7XG4gICAgICAgIHRoaXMuc3RvcHMgPSBuZXcgTWFwKFxuICAgICAgICAgICAgZ3JhZGllbnQuc3RvcHMubGVuZ3RoXG4gICAgICAgICAgICAgICAgPyBncmFkaWVudC5zdG9wcy5tYXA8W251bWJlciwgW251bWJlciwgbnVtYmVyLCBudW1iZXIsIG51bWJlcl1dPihcbiAgICAgICAgICAgICAgICAgICAgICAoe2NvbG9yLCBwb3NpdGlvbn0pID0+IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChwb3NpdGlvbikgLyAxMDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHR1aVBhcnNlQ29sb3IoY29sb3IpLFxuICAgICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgOiB0aGlzLnNlbGVjdG9yT3B0aW9ucy5ncmFkaWVudC5zdGVwcyxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlQ29sb3IoY29sb3I6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLmN1cnJlbnRTdG9wID0gdGhpcy5zZWxlY3Rvck9wdGlvbnMuZ3JhZGllbnQuc3RvcDtcbiAgICAgICAgdGhpcy5jb2xvciA9IHR1aVBhcnNlQ29sb3IoY29sb3IpO1xuICAgIH1cbn1cbiIsIjxuZy1jb250YWluZXIgKm5nSWY9XCJzZWxlY3Rvck1vZGVcIj5cbiAgICA8ZGl2XG4gICAgICAgIGNsYXNzPVwidC1zZWxlY3RcIlxuICAgICAgICBbdHVpRHJvcGRvd25dPVwibWVudVwiXG4gICAgICAgIFsodHVpRHJvcGRvd25PcGVuKV09XCJvcGVuXCJcbiAgICA+XG4gICAgICAgIDxidXR0b25cbiAgICAgICAgICAgIGFwcGVhcmFuY2U9XCJcIlxuICAgICAgICAgICAgc2l6ZT1cInNcIlxuICAgICAgICAgICAgdHVpQnV0dG9uXG4gICAgICAgICAgICB0dWlDaGV2cm9uXG4gICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgPlxuICAgICAgICAgICAge3sgY3VycmVudE1vZGUgfX1cbiAgICAgICAgPC9idXR0b24+XG5cbiAgICAgICAgPG5nLXRlbXBsYXRlICNtZW51PlxuICAgICAgICAgICAgPHR1aS1kYXRhLWxpc3RcbiAgICAgICAgICAgICAgICByb2xlPVwibWVudVwiXG4gICAgICAgICAgICAgICAgc2l6ZT1cInNcIlxuICAgICAgICAgICAgICAgIGNsYXNzPVwidC1tZW51XCJcbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICpuZ0Zvcj1cImxldCBtb2RlIG9mIG1vZGVzXCJcbiAgICAgICAgICAgICAgICAgICAgcm9sZT1cIm1lbnVpdGVtcmFkaW9cIlxuICAgICAgICAgICAgICAgICAgICB0dWlPcHRpb25cbiAgICAgICAgICAgICAgICAgICAgdHlwZT1cImJ1dHRvblwiXG4gICAgICAgICAgICAgICAgICAgIFthdHRyLmFyaWEtY2hlY2tlZF09XCJpc01vZGVBY3RpdmUobW9kZSlcIlxuICAgICAgICAgICAgICAgICAgICAoY2xpY2spPVwib25Nb2RlU2VsZWN0KG1vZGUpXCJcbiAgICAgICAgICAgICAgICAgICAgKGtleWRvd24uZW50ZXIucHJldmVudCk9XCJvbk1vZGVTZWxlY3QobW9kZSlcIlxuICAgICAgICAgICAgICAgICAgICAoa2V5ZG93bi5zcGFjZS5wcmV2ZW50KT1cIm9uTW9kZVNlbGVjdChtb2RlKVwiXG4gICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICB7eyBtb2RlIH19XG4gICAgICAgICAgICAgICAgICAgIDx0dWktaWNvblxuICAgICAgICAgICAgICAgICAgICAgICAgKm5nSWY9XCJpc01vZGVBY3RpdmUobW9kZSlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbj1cIkB0dWkuY2hlY2tcIlxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3M9XCJ0LWNoZWNrbWFya1wiXG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9idXR0b24+XG4gICAgICAgICAgICA8L3R1aS1kYXRhLWxpc3Q+XG4gICAgICAgIDwvbmctdGVtcGxhdGU+XG4gICAgPC9kaXY+XG4gICAgPGhyIGNsYXNzPVwidC1oclwiIC8+XG48L25nLWNvbnRhaW5lcj5cblxuPG5nLWNvbnRhaW5lciAqbmdJZj1cImlzR3JhZGllbnRcIj5cbiAgICA8ZGl2XG4gICAgICAgIGNsYXNzPVwidC13cmFwcGVyXCJcbiAgICAgICAgW3N0eWxlLmJhY2tncm91bmRdPVwiZ3JhZGllbnRcIlxuICAgID5cbiAgICAgICAgPHR1aS1saW5lYXItbXVsdGktcGlja2VyXG4gICAgICAgICAgICBjbGFzcz1cInQtZ3JhZGllbnRcIlxuICAgICAgICAgICAgW3ZhbHVlXT1cInN0b3BzS2V5c1wiXG4gICAgICAgICAgICAoaW5kZXhDaGFuZ2UpPVwib25JbmRleENoYW5nZSgkZXZlbnQpXCJcbiAgICAgICAgICAgICh2YWx1ZUNoYW5nZSk9XCJvblN0b3BzQ2hhbmdlKCRldmVudClcIlxuICAgICAgICAvPlxuICAgIDwvZGl2PlxuICAgIDxkaXYgY2xhc3M9XCJ0LWJ1dHRvbnNcIj5cbiAgICAgICAgPCEtLSBUT0RPOiBDaGFuZ2UgdG8gYHR1aUhpbnREZXNjcmliZWAgd2hlbiBmaWd1cmUgdHVpRHJpdmVyIG9yZGVyIGlzc3VlIC0tPlxuICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAqbmdGb3I9XCJsZXQgYnV0dG9uIG9mIGJ1dHRvbnNcIlxuICAgICAgICAgICAgYXBwZWFyYW5jZT1cIlwiXG4gICAgICAgICAgICBzaXplPVwieHNcIlxuICAgICAgICAgICAgdHVpSGludERlc2NyaWJlXG4gICAgICAgICAgICB0dWlJY29uQnV0dG9uXG4gICAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICAgIGNsYXNzPVwidC1kaXJlY3Rpb25cIlxuICAgICAgICAgICAgW2NsYXNzLnQtZGlyZWN0aW9uX2FjdGl2ZV09XCJpc0RpcmVjdGlvbkFjdGl2ZShidXR0b24pXCJcbiAgICAgICAgICAgIFtpY29uU3RhcnRdPVwiZ2V0SWNvbihidXR0b24pXCJcbiAgICAgICAgICAgIFt0dWlIaW50XT1cImJ1dHRvblwiXG4gICAgICAgICAgICAoY2xpY2spPVwib25EaXJlY3Rpb25DaGFuZ2UoYnV0dG9uKVwiXG4gICAgICAgID48L2J1dHRvbj5cbiAgICA8L2Rpdj5cbjwvbmctY29udGFpbmVyPlxuPHR1aS1jb2xvci1waWNrZXJcbiAgICBbY29sb3JdPVwiY3VycmVudENvbG9yXCJcbiAgICAoY29sb3JDaGFuZ2UpPVwib25Db2xvckNoYW5nZSgkZXZlbnQpXCJcbi8+XG48dHVpLWNvbG9yLWVkaXRcbiAgICAqbmdJZj1cIiFpc0dyYWRpZW50XCJcbiAgICB0dWlHcm91cFxuICAgIGNsYXNzPVwidC1lZGl0XCJcbiAgICBbY29sb3JdPVwiY29sb3JcIlxuICAgIChjb2xvckNoYW5nZSk9XCJvbkNvbG9yQ2hhbmdlKCRldmVudClcIlxuLz5cbjx0dWktcGFsZXR0ZVxuICAgICpuZ0lmPVwicGFsZXR0ZS5zaXplXCJcbiAgICBjbGFzcz1cInQtcGFsZXR0ZVwiXG4gICAgW2NvbG9yc109XCJwYWxldHRlXCJcbiAgICAoc2VsZWN0ZWRDb2xvcik9XCJvblBhbGV0dGVQaWNrKCRldmVudClcIlxuLz5cbiJdfQ==