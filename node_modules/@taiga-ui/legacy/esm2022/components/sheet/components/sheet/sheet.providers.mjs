import { DOCUMENT } from '@angular/common';
import { ElementRef, forwardRef, NgZone } from '@angular/core';
import { TUI_FALSE_HANDLER, TUI_TRUE_HANDLER } from '@taiga-ui/cdk/constants';
import { tuiTypedFromEvent, tuiZonefree } from '@taiga-ui/cdk/observables';
import { TUI_IS_IOS } from '@taiga-ui/cdk/tokens';
import { tuiProvide } from '@taiga-ui/cdk/utils/miscellaneous';
import { TUI_SCROLL_REF } from '@taiga-ui/core/tokens';
import { concat, delay, map, merge, share, switchMap, take, takeUntil, zip } from 'rxjs';
import { TUI_SHEET, TUI_SHEET_DRAGGED, TUI_SHEET_SCROLL } from '../../sheet-tokens';
import { TuiSheetComponent } from './sheet.component';
export const TUI_SHEET_PROVIDERS = [
    {
        provide: TUI_SHEET_DRAGGED,
        deps: [ElementRef],
        useFactory: ({ nativeElement }) => merge(tuiTypedFromEvent(nativeElement, 'touchstart', { passive: true }).pipe(map(TUI_TRUE_HANDLER)), tuiTypedFromEvent(nativeElement, 'touchend').pipe(map(TUI_FALSE_HANDLER))),
    },
    {
        provide: TUI_SHEET_SCROLL,
        deps: [ElementRef, NgZone, DOCUMENT, TUI_IS_IOS],
        useFactory: ({ nativeElement }, zone, doc, isIos) => isIos
            ? iosScrollFactory(nativeElement, doc, zone)
            : merge(tuiTypedFromEvent(nativeElement, 'scroll'), tuiTypedFromEvent(nativeElement, 'load', { capture: true })).pipe(map(() => nativeElement.scrollTop), tuiZonefree(zone), share()),
    },
    tuiProvide(TUI_SCROLL_REF, ElementRef),
    tuiProvide(TUI_SHEET, forwardRef(() => TuiSheetComponent)),
];
function iosScrollFactory(element, doc, zone) {
    const load$ = tuiTypedFromEvent(element, 'load', { capture: true });
    const touchstart$ = tuiTypedFromEvent(element, 'touchstart', { passive: true });
    const touchmove$ = tuiTypedFromEvent(doc, 'touchmove', { passive: true });
    const touchend$ = tuiTypedFromEvent(doc, 'touchend');
    const scroll$ = tuiTypedFromEvent(element, 'scroll').pipe(map(() => element.scrollTop));
    const result$ = merge(load$.pipe(delay(0), map(() => element.scrollTop)), touchstart$.pipe(switchMap(({ touches }) => {
        const { screenY = 0 } = touches[0] ?? {};
        const { scrollTop } = element;
        return concat(
        // Sometimes touch is triggered without scroll in iOS, filter that
        zip(touchmove$, scroll$).pipe(map(([{ touches }]) => scrollTop + screenY - (touches[0]?.screenY ?? 0)), takeUntil(touchend$)), scroll$);
    })));
    return concat(scroll$.pipe(take(1)), result$).pipe(tuiZonefree(zone), share());
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlZXQucHJvdmlkZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbGVnYWN5L2NvbXBvbmVudHMvc2hlZXQvY29tcG9uZW50cy9zaGVldC9zaGVldC5wcm92aWRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBRXpDLE9BQU8sRUFBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUMsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUM1RSxPQUFPLEVBQUMsaUJBQWlCLEVBQUUsV0FBVyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFDekUsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxtQ0FBbUMsQ0FBQztBQUM3RCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFFckQsT0FBTyxFQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRXZGLE9BQU8sRUFBQyxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRixPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUVwRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBZTtJQUMzQztRQUNJLE9BQU8sRUFBRSxpQkFBaUI7UUFDMUIsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDO1FBQ2xCLFVBQVUsRUFBRSxDQUFDLEVBQUMsYUFBYSxFQUEwQixFQUF1QixFQUFF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SUFBSSxDQUFDLENBQUMsQ0FDdkQsRUFDRCxTQUFTLENBQUMsU0FBUyxDQUFDLENBQ3ZCLEVBQ0QsT0FBTyxDQUNWLENBQUM7SUFDTixDQUFDLENBQUMsQ0FDTCxDQUNKLENBQUM7SUFFRixPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUNuRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtET0NVTUVOVH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB0eXBlIHtQcm92aWRlcn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0VsZW1lbnRSZWYsIGZvcndhcmRSZWYsIE5nWm9uZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1RVSV9GQUxTRV9IQU5ETEVSLCBUVUlfVFJVRV9IQU5ETEVSfSBmcm9tICdAdGFpZ2EtdWkvY2RrL2NvbnN0YW50cyc7XG5pbXBvcnQge3R1aVR5cGVkRnJvbUV2ZW50LCB0dWlab25lZnJlZX0gZnJvbSAnQHRhaWdhLXVpL2Nkay9vYnNlcnZhYmxlcyc7XG5pbXBvcnQge1RVSV9JU19JT1N9IGZyb20gJ0B0YWlnYS11aS9jZGsvdG9rZW5zJztcbmltcG9ydCB7dHVpUHJvdmlkZX0gZnJvbSAnQHRhaWdhLXVpL2Nkay91dGlscy9taXNjZWxsYW5lb3VzJztcbmltcG9ydCB7VFVJX1NDUk9MTF9SRUZ9IGZyb20gJ0B0YWlnYS11aS9jb3JlL3Rva2Vucyc7XG5pbXBvcnQgdHlwZSB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2NvbmNhdCwgZGVsYXksIG1hcCwgbWVyZ2UsIHNoYXJlLCBzd2l0Y2hNYXAsIHRha2UsIHRha2VVbnRpbCwgemlwfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtUVUlfU0hFRVQsIFRVSV9TSEVFVF9EUkFHR0VELCBUVUlfU0hFRVRfU0NST0xMfSBmcm9tICcuLi8uLi9zaGVldC10b2tlbnMnO1xuaW1wb3J0IHtUdWlTaGVldENvbXBvbmVudH0gZnJvbSAnLi9zaGVldC5jb21wb25lbnQnO1xuXG5leHBvcnQgY29uc3QgVFVJX1NIRUVUX1BST1ZJREVSUzogUHJvdmlkZXJbXSA9IFtcbiAgICB7XG4gICAgICAgIHByb3ZpZGU6IFRVSV9TSEVFVF9EUkFHR0VELFxuICAgICAgICBkZXBzOiBbRWxlbWVudFJlZl0sXG4gICAgICAgIHVzZUZhY3Rvcnk6ICh7bmF0aXZlRWxlbWVudH06IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+KTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PlxuICAgICAgICAgICAgbWVyZ2UoXG4gICAgICAgICAgICAgICAgdHVpVHlwZWRGcm9tRXZlbnQobmF0aXZlRWxlbWVudCwgJ3RvdWNoc3RhcnQnLCB7cGFzc2l2ZTogdHJ1ZX0pLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIG1hcChUVUlfVFJVRV9IQU5ETEVSKSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHR1aVR5cGVkRnJvbUV2ZW50KG5hdGl2ZUVsZW1lbnQsICd0b3VjaGVuZCcpLnBpcGUobWFwKFRVSV9GQUxTRV9IQU5ETEVSKSksXG4gICAgICAgICAgICApLFxuICAgIH0sXG4gICAge1xuICAgICAgICBwcm92aWRlOiBUVUlfU0hFRVRfU0NST0xMLFxuICAgICAgICBkZXBzOiBbRWxlbWVudFJlZiwgTmdab25lLCBET0NVTUVOVCwgVFVJX0lTX0lPU10sXG4gICAgICAgIHVzZUZhY3Rvcnk6IChcbiAgICAgICAgICAgIHtuYXRpdmVFbGVtZW50fTogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgICAgICAgICB6b25lOiBOZ1pvbmUsXG4gICAgICAgICAgICBkb2M6IERvY3VtZW50LFxuICAgICAgICAgICAgaXNJb3M6IGJvb2xlYW4sXG4gICAgICAgICk6IE9ic2VydmFibGU8bnVtYmVyPiA9PlxuICAgICAgICAgICAgaXNJb3NcbiAgICAgICAgICAgICAgICA/IGlvc1Njcm9sbEZhY3RvcnkobmF0aXZlRWxlbWVudCwgZG9jLCB6b25lKVxuICAgICAgICAgICAgICAgIDogbWVyZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgdHVpVHlwZWRGcm9tRXZlbnQobmF0aXZlRWxlbWVudCwgJ3Njcm9sbCcpLFxuICAgICAgICAgICAgICAgICAgICAgIHR1aVR5cGVkRnJvbUV2ZW50KG5hdGl2ZUVsZW1lbnQsICdsb2FkJywge2NhcHR1cmU6IHRydWV9KSxcbiAgICAgICAgICAgICAgICAgICkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICBtYXAoKCkgPT4gbmF0aXZlRWxlbWVudC5zY3JvbGxUb3ApLFxuICAgICAgICAgICAgICAgICAgICAgIHR1aVpvbmVmcmVlKHpvbmUpLFxuICAgICAgICAgICAgICAgICAgICAgIHNoYXJlKCksXG4gICAgICAgICAgICAgICAgICApLFxuICAgIH0sXG4gICAgdHVpUHJvdmlkZShUVUlfU0NST0xMX1JFRiwgRWxlbWVudFJlZiksXG4gICAgdHVpUHJvdmlkZShcbiAgICAgICAgVFVJX1NIRUVULFxuICAgICAgICBmb3J3YXJkUmVmKCgpID0+IFR1aVNoZWV0Q29tcG9uZW50KSxcbiAgICApLFxuXTtcblxuZnVuY3Rpb24gaW9zU2Nyb2xsRmFjdG9yeShcbiAgICBlbGVtZW50OiBIVE1MRWxlbWVudCxcbiAgICBkb2M6IERvY3VtZW50LFxuICAgIHpvbmU6IE5nWm9uZSxcbik6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgY29uc3QgbG9hZCQgPSB0dWlUeXBlZEZyb21FdmVudChlbGVtZW50LCAnbG9hZCcsIHtjYXB0dXJlOiB0cnVlfSk7XG4gICAgY29uc3QgdG91Y2hzdGFydCQgPSB0dWlUeXBlZEZyb21FdmVudChlbGVtZW50LCAndG91Y2hzdGFydCcsIHtwYXNzaXZlOiB0cnVlfSk7XG4gICAgY29uc3QgdG91Y2htb3ZlJCA9IHR1aVR5cGVkRnJvbUV2ZW50KGRvYywgJ3RvdWNobW92ZScsIHtwYXNzaXZlOiB0cnVlfSk7XG4gICAgY29uc3QgdG91Y2hlbmQkID0gdHVpVHlwZWRGcm9tRXZlbnQoZG9jLCAndG91Y2hlbmQnKTtcbiAgICBjb25zdCBzY3JvbGwkID0gdHVpVHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ3Njcm9sbCcpLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiBlbGVtZW50LnNjcm9sbFRvcCksXG4gICAgKTtcbiAgICBjb25zdCByZXN1bHQkID0gbWVyZ2UoXG4gICAgICAgIGxvYWQkLnBpcGUoXG4gICAgICAgICAgICBkZWxheSgwKSxcbiAgICAgICAgICAgIG1hcCgoKSA9PiBlbGVtZW50LnNjcm9sbFRvcCksXG4gICAgICAgICksXG4gICAgICAgIHRvdWNoc3RhcnQkLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKHt0b3VjaGVzfSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHtzY3JlZW5ZID0gMH0gPSB0b3VjaGVzWzBdID8/IHt9O1xuICAgICAgICAgICAgICAgIGNvbnN0IHtzY3JvbGxUb3B9ID0gZWxlbWVudDtcblxuICAgICAgICAgICAgICAgIHJldHVybiBjb25jYXQoXG4gICAgICAgICAgICAgICAgICAgIC8vIFNvbWV0aW1lcyB0b3VjaCBpcyB0cmlnZ2VyZWQgd2l0aG91dCBzY3JvbGwgaW4gaU9TLCBmaWx0ZXIgdGhhdFxuICAgICAgICAgICAgICAgICAgICB6aXAodG91Y2htb3ZlJCwgc2Nyb2xsJCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoW3t0b3VjaGVzfV0pID0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcCArIHNjcmVlblkgLSAodG91Y2hlc1swXT8uc2NyZWVuWSA/PyAwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWtlVW50aWwodG91Y2hlbmQkKSxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsJCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICksXG4gICAgKTtcblxuICAgIHJldHVybiBjb25jYXQoc2Nyb2xsJC5waXBlKHRha2UoMSkpLCByZXN1bHQkKS5waXBlKHR1aVpvbmVmcmVlKHpvbmUpLCBzaGFyZSgpKTtcbn1cbiJdfQ==