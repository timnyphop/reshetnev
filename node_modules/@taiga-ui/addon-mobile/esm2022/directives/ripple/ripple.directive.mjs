import { DOCUMENT } from '@angular/common';
import { ChangeDetectionStrategy, Component, DestroyRef, Directive, inject, Input, ViewEncapsulation, } from '@angular/core';
import { takeUntilDestroyed } from '@angular/core/rxjs-interop';
import { tuiTypedFromEvent } from '@taiga-ui/cdk/observables';
import { tuiIsHTMLElement } from '@taiga-ui/cdk/utils/dom';
import { tuiPx, tuiWithStyles } from '@taiga-ui/cdk/utils/miscellaneous';
import { TUI_ANIMATIONS_SPEED } from '@taiga-ui/core/tokens';
import { tuiGetDuration } from '@taiga-ui/core/utils/miscellaneous';
import { first, merge, race, switchMap, tap } from 'rxjs';
import * as i0 from "@angular/core";
const DEFAULT_SELECTOR = ':scope';
const TO_KEYFRAMES = [
    {
        transform: 'scale(0)',
        opacity: '0.12',
    },
    {
        opacity: '0.12',
    },
];
const FROM_KEYFRAMES = [
    {
        opacity: '0.12',
    },
    {
        opacity: '0',
    },
];
function selectorScopeFallback(value) {
    return value === '' ? DEFAULT_SELECTOR : value;
}
class TuiRippleStyles {
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiRippleStyles, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TuiRippleStyles, isStandalone: true, selector: "ng-component", host: { classAttribute: "tui-ripple-styles" }, ngImport: i0, template: '', isInline: true, styles: [".tui-ripple{position:absolute;z-index:100;opacity:.12;border-radius:100%;background:var(--tui-ripple-background, currentColor);animation-fill-mode:forwards;pointer-events:none}\n"], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiRippleStyles, decorators: [{
            type: Component,
            args: [{ standalone: true, template: '', encapsulation: ViewEncapsulation.None, changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        class: 'tui-ripple-styles',
                    }, styles: [".tui-ripple{position:absolute;z-index:100;opacity:.12;border-radius:100%;background:var(--tui-ripple-background, currentColor);animation-fill-mode:forwards;pointer-events:none}\n"] }]
        }] });
class TuiRipple {
    constructor() {
        this.document = inject(DOCUMENT);
        this.destroyRef = inject(DestroyRef);
        this.animationOptions = {
            duration: tuiGetDuration(inject(TUI_ANIMATIONS_SPEED)),
        };
        this.nothing = tuiWithStyles(TuiRippleStyles);
        this.selector = DEFAULT_SELECTOR;
    }
    start(x, y, target) {
        const element = target.closest(this.selector);
        if (!tuiIsHTMLElement(element)) {
            return;
        }
        const ripple = this.createRipple(x, y, element.getBoundingClientRect());
        const touchEnd$ = merge(tuiTypedFromEvent(element, 'pointerup'), tuiTypedFromEvent(element, 'pointercancel'), tuiTypedFromEvent(element, 'pointermove'));
        element.appendChild(ripple);
        const animationEndOn$ = tuiTypedFromEvent(ripple.animate(TO_KEYFRAMES, this.animationOptions), 'finish');
        race(touchEnd$.pipe(switchMap(() => animationEndOn$)), animationEndOn$.pipe(switchMap(() => touchEnd$)))
            .pipe(first(), switchMap(() => tuiTypedFromEvent(ripple.animate(FROM_KEYFRAMES, this.animationOptions), 'finish')), first(), tap(() => element.removeChild(ripple)), takeUntilDestroyed(this.destroyRef))
            .subscribe();
    }
    createRipple(clientX, clientY, { width, height, top, left }) {
        const ripple = this.document.createElement('div');
        const radius = Math.sqrt(width * width + height * height);
        const dimension = radius * 2;
        const x = clientX - left - radius;
        const y = clientY - top - radius;
        Object.assign(ripple.style, {
            position: 'absolute',
            top: tuiPx(y),
            left: tuiPx(x),
            width: tuiPx(dimension),
            height: tuiPx(dimension),
            zIndex: 100,
            opacity: 0.12,
            borderRadius: '100%',
            background: 'var(--tui-ripple-background, currentColor)',
            animationFillMode: 'forwards',
            pointerEvents: 'none',
        });
        return ripple;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiRipple, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "16.2.12", type: TuiRipple, isStandalone: true, selector: "[tuiRipple]", inputs: { selector: ["tuiRipple", "selector", selectorScopeFallback] }, host: { listeners: { "pointerdown.silent": "start($event.clientX, $event.clientY, $event.target)" } }, ngImport: i0 }); }
}
export { TuiRipple };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiRipple, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: '[tuiRipple]',
                    host: {
                        '(pointerdown.silent)': 'start($event.clientX, $event.clientY, $event.target)',
                    },
                }]
        }], propDecorators: { selector: [{
                type: Input,
                args: [{
                        alias: 'tuiRipple',
                        transform: selectorScopeFallback,
                    }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmlwcGxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FkZG9uLW1vYmlsZS9kaXJlY3RpdmVzL3JpcHBsZS9yaXBwbGUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQ0gsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsU0FBUyxFQUNULE1BQU0sRUFDTixLQUFLLEVBQ0wsaUJBQWlCLEdBQ3BCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQzVELE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBQ3pELE9BQU8sRUFBQyxLQUFLLEVBQUUsYUFBYSxFQUFDLE1BQU0sbUNBQW1DLENBQUM7QUFDdkUsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDM0QsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBQ2xFLE9BQU8sRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFDLE1BQU0sTUFBTSxDQUFDOztBQUV4RCxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQztBQUNsQyxNQUFNLFlBQVksR0FBRztJQUNqQjtRQUNJLFNBQVMsRUFBRSxVQUFVO1FBQ3JCLE9BQU8sRUFBRSxNQUFNO0tBQ2xCO0lBQ0Q7UUFDSSxPQUFPLEVBQUUsTUFBTTtLQUNsQjtDQUNKLENBQUM7QUFDRixNQUFNLGNBQWMsR0FBRztJQUNuQjtRQUNJLE9BQU8sRUFBRSxNQUFNO0tBQ2xCO0lBQ0Q7UUFDSSxPQUFPLEVBQUUsR0FB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QUMxRCxNQUFNLFNBQVMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLE1BQU0sQ0FBQyxHQUFHLE9BQU8sR0FBRyxJQUFJLEdBQUcsTUFBTSxDQUFDO1FBQ2xDLE1BQU0sQ0FBQyxHQUFHLE9BQU8sR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDO1FBRWpDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRTtZQUN4QixRQUFRLEVBQUUsVUFBVTtZQUNwQixHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNiLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2QsS0FBSyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUM7WUFDdkIsTUFBTSxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUM7WUFDeEIsTUFBTSxFQUFFLEdBQUc7WUFDWCxPQUFPLEVBQUUsSUFBSTtZQUNiLFlBQVksRUFBRSxNQUFNO1lBQ3BCLFVBQVUsRUFBRSw0Q0FBNEM7WUFDeEQsaUJBQWlCLEVBQUUsVUFBVTtZQUM3QixhQUFhLEVBQUUsTUFBTTtTQUN4QixDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOytHQWpGUSxTQUFTO21HQUFULFNBQVMsNkZBdkJiLHFCQUFxQjs7U0F1QmpCLFNBQVM7NEZBQVQsU0FBUztrQkFQckIsU0FBUzttQkFBQztvQkFDUCxVQUFVLEVBQUUsSUFBSTtvQkFDaEIsUUFBUSxFQUFFLGFBQWE7b0JBQ3ZCLElBQUksRUFBRTt3QkFDRixzQkFBc0IsRUFBRSxzREFBc0Q7cUJBQ2pGO2lCQUNKOzhCQWNVLFFBQVE7c0JBSmQsS0FBSzt1QkFBQzt3QkFDSCxLQUFLLEVBQUUsV0FBVzt3QkFDbEIsU0FBUyxFQUFFLHFCQUFxQjtxQkFDbkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RPQ1VNRU5UfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgICBDb21wb25lbnQsXG4gICAgRGVzdHJveVJlZixcbiAgICBEaXJlY3RpdmUsXG4gICAgaW5qZWN0LFxuICAgIElucHV0LFxuICAgIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7dGFrZVVudGlsRGVzdHJveWVkfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XG5pbXBvcnQge3R1aVR5cGVkRnJvbUV2ZW50fSBmcm9tICdAdGFpZ2EtdWkvY2RrL29ic2VydmFibGVzJztcbmltcG9ydCB7dHVpSXNIVE1MRWxlbWVudH0gZnJvbSAnQHRhaWdhLXVpL2Nkay91dGlscy9kb20nO1xuaW1wb3J0IHt0dWlQeCwgdHVpV2l0aFN0eWxlc30gZnJvbSAnQHRhaWdhLXVpL2Nkay91dGlscy9taXNjZWxsYW5lb3VzJztcbmltcG9ydCB7VFVJX0FOSU1BVElPTlNfU1BFRUR9IGZyb20gJ0B0YWlnYS11aS9jb3JlL3Rva2Vucyc7XG5pbXBvcnQge3R1aUdldER1cmF0aW9ufSBmcm9tICdAdGFpZ2EtdWkvY29yZS91dGlscy9taXNjZWxsYW5lb3VzJztcbmltcG9ydCB7Zmlyc3QsIG1lcmdlLCByYWNlLCBzd2l0Y2hNYXAsIHRhcH0gZnJvbSAncnhqcyc7XG5cbmNvbnN0IERFRkFVTFRfU0VMRUNUT1IgPSAnOnNjb3BlJztcbmNvbnN0IFRPX0tFWUZSQU1FUyA9IFtcbiAgICB7XG4gICAgICAgIHRyYW5zZm9ybTogJ3NjYWxlKDApJyxcbiAgICAgICAgb3BhY2l0eTogJzAuMTInLFxuICAgIH0sXG4gICAge1xuICAgICAgICBvcGFjaXR5OiAnMC4xMicsXG4gICAgfSxcbl07XG5jb25zdCBGUk9NX0tFWUZSQU1FUyA9IFtcbiAgICB7XG4gICAgICAgIG9wYWNpdHk6ICcwLjEyJyxcbiAgICB9LFxuICAgIHtcbiAgICAgICAgb3BhY2l0eTogJzAnLFxuICAgIH0sXG5dO1xuXG5mdW5jdGlvbiBzZWxlY3RvclNjb3BlRmFsbGJhY2sodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IERFRkFVTFRfU0VMRUNUT1IgOiB2YWx1ZTtcbn1cblxuQENvbXBvbmVudCh7XG4gICAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgICB0ZW1wbGF0ZTogJycsXG4gICAgc3R5bGVVcmxzOiBbJy4vcmlwcGxlLnN0eWxlLmxlc3MnXSxcbiAgICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICAgIGhvc3Q6IHtcbiAgICAgICAgY2xhc3M6ICd0dWktcmlwcGxlLXN0eWxlcycsXG4gICAgfSxcbn0pXG5jbGFzcyBUdWlSaXBwbGVTdHlsZXMge31cblxuQERpcmVjdGl2ZSh7XG4gICAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgICBzZWxlY3RvcjogJ1t0dWlSaXBwbGVdJyxcbiAgICBob3N0OiB7XG4gICAgICAgICcocG9pbnRlcmRvd24uc2lsZW50KSc6ICdzdGFydCgkZXZlbnQuY2xpZW50WCwgJGV2ZW50LmNsaWVudFksICRldmVudC50YXJnZXQpJyxcbiAgICB9LFxufSlcbmV4cG9ydCBjbGFzcyBUdWlSaXBwbGUge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnQgPSBpbmplY3QoRE9DVU1FTlQpO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveVJlZiA9IGluamVjdChEZXN0cm95UmVmKTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFuaW1hdGlvbk9wdGlvbnMgPSB7XG4gICAgICAgIGR1cmF0aW9uOiB0dWlHZXREdXJhdGlvbihpbmplY3QoVFVJX0FOSU1BVElPTlNfU1BFRUQpKSxcbiAgICB9O1xuXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IG5vdGhpbmcgPSB0dWlXaXRoU3R5bGVzKFR1aVJpcHBsZVN0eWxlcyk7XG5cbiAgICBASW5wdXQoe1xuICAgICAgICBhbGlhczogJ3R1aVJpcHBsZScsXG4gICAgICAgIHRyYW5zZm9ybTogc2VsZWN0b3JTY29wZUZhbGxiYWNrLFxuICAgIH0pXG4gICAgcHVibGljIHNlbGVjdG9yID0gREVGQVVMVF9TRUxFQ1RPUjtcblxuICAgIHByb3RlY3RlZCBzdGFydCh4OiBudW1iZXIsIHk6IG51bWJlciwgdGFyZ2V0OiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgICAgICBjb25zdCBlbGVtZW50ID0gdGFyZ2V0LmNsb3Nlc3QodGhpcy5zZWxlY3Rvcik7XG5cbiAgICAgICAgaWYgKCF0dWlJc0hUTUxFbGVtZW50KGVsZW1lbnQpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByaXBwbGUgPSB0aGlzLmNyZWF0ZVJpcHBsZSh4LCB5LCBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKTtcbiAgICAgICAgY29uc3QgdG91Y2hFbmQkID0gbWVyZ2UoXG4gICAgICAgICAgICB0dWlUeXBlZEZyb21FdmVudChlbGVtZW50LCAncG9pbnRlcnVwJyksXG4gICAgICAgICAgICB0dWlUeXBlZEZyb21FdmVudChlbGVtZW50LCAncG9pbnRlcmNhbmNlbCcpLFxuICAgICAgICAgICAgdHVpVHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ3BvaW50ZXJtb3ZlJyksXG4gICAgICAgICk7XG5cbiAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChyaXBwbGUpO1xuXG4gICAgICAgIGNvbnN0IGFuaW1hdGlvbkVuZE9uJCA9IHR1aVR5cGVkRnJvbUV2ZW50KFxuICAgICAgICAgICAgcmlwcGxlLmFuaW1hdGUoVE9fS0VZRlJBTUVTLCB0aGlzLmFuaW1hdGlvbk9wdGlvbnMpLFxuICAgICAgICAgICAgJ2ZpbmlzaCcsXG4gICAgICAgICk7XG5cbiAgICAgICAgcmFjZShcbiAgICAgICAgICAgIHRvdWNoRW5kJC5waXBlKHN3aXRjaE1hcCgoKSA9PiBhbmltYXRpb25FbmRPbiQpKSxcbiAgICAgICAgICAgIGFuaW1hdGlvbkVuZE9uJC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0b3VjaEVuZCQpKSxcbiAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT5cbiAgICAgICAgICAgICAgICAgICAgdHVpVHlwZWRGcm9tRXZlbnQoXG4gICAgICAgICAgICAgICAgICAgICAgICByaXBwbGUuYW5pbWF0ZShGUk9NX0tFWUZSQU1FUywgdGhpcy5hbmltYXRpb25PcHRpb25zKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICdmaW5pc2gnLFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgZmlyc3QoKSxcbiAgICAgICAgICAgICAgICB0YXAoKCkgPT4gZWxlbWVudC5yZW1vdmVDaGlsZChyaXBwbGUpKSxcbiAgICAgICAgICAgICAgICB0YWtlVW50aWxEZXN0cm95ZWQodGhpcy5kZXN0cm95UmVmKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVJpcHBsZShcbiAgICAgICAgY2xpZW50WDogbnVtYmVyLFxuICAgICAgICBjbGllbnRZOiBudW1iZXIsXG4gICAgICAgIHt3aWR0aCwgaGVpZ2h0LCB0b3AsIGxlZnR9OiBET01SZWN0LFxuICAgICk6IEhUTUxFbGVtZW50IHtcbiAgICAgICAgY29uc3QgcmlwcGxlOiBIVE1MRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIGNvbnN0IHJhZGl1cyA9IE1hdGguc3FydCh3aWR0aCAqIHdpZHRoICsgaGVpZ2h0ICogaGVpZ2h0KTtcbiAgICAgICAgY29uc3QgZGltZW5zaW9uID0gcmFkaXVzICogMjtcbiAgICAgICAgY29uc3QgeCA9IGNsaWVudFggLSBsZWZ0IC0gcmFkaXVzO1xuICAgICAgICBjb25zdCB5ID0gY2xpZW50WSAtIHRvcCAtIHJhZGl1cztcblxuICAgICAgICBPYmplY3QuYXNzaWduKHJpcHBsZS5zdHlsZSwge1xuICAgICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsXG4gICAgICAgICAgICB0b3A6IHR1aVB4KHkpLFxuICAgICAgICAgICAgbGVmdDogdHVpUHgoeCksXG4gICAgICAgICAgICB3aWR0aDogdHVpUHgoZGltZW5zaW9uKSxcbiAgICAgICAgICAgIGhlaWdodDogdHVpUHgoZGltZW5zaW9uKSxcbiAgICAgICAgICAgIHpJbmRleDogMTAwLFxuICAgICAgICAgICAgb3BhY2l0eTogMC4xMixcbiAgICAgICAgICAgIGJvcmRlclJhZGl1czogJzEwMCUnLFxuICAgICAgICAgICAgYmFja2dyb3VuZDogJ3ZhcigtLXR1aS1yaXBwbGUtYmFja2dyb3VuZCwgY3VycmVudENvbG9yKScsXG4gICAgICAgICAgICBhbmltYXRpb25GaWxsTW9kZTogJ2ZvcndhcmRzJyxcbiAgICAgICAgICAgIHBvaW50ZXJFdmVudHM6ICdub25lJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJpcHBsZTtcbiAgICB9XG59XG4iXX0=